version: ~> 1.0
import: nix-community/nix-travis-ci:nix.yml@main
env:
  - NIX_PATH: nixpkgs=channel:nixpkgs-unstable
git:
  depth: 3
  quiet: true
  submodules: false
cache:
  directories:
    - $HOME/.gradle/caches
    - $HOME/.gradle/wrapper
    - $HOME/nix.store
before_install:
  - sudo mkdir -p /etc/nix
  - echo 'sandbox = true' | sudo tee -a /etc/nix/nix.conf > /dev/null
  - echo "substituters = https://cache.nixos.org/ file://$HOME/nix.store" | sudo tee -a /etc/nix/nix.conf > /dev/null
  - echo 'require-sigs = false' | sudo tee -a /etc/nix/nix.conf > /dev/null
before_cache:
  - rm -f $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
  - mkdir -p $HOME/nix.store
  - nix copy --to file://$HOME/nix.store -f sample.nix
jobs:
  include:
    - stage: test
      script: scripts/test.sh
      if: type != cron
    - stage: deploy
      script: scripts/deploy.sh
      if: branch = master AND type = cron
    - stage: channel
      script: scripts/channel.sh
      if: branch = master
      deploy:
        provider: pages
        skip_cleanup: true
        github_token: $GH_TOKEN
        local_dir: build
        on:
          branch: master
